import os
from utils.port_scanner import scan_ports
from utils.banner_grabber import grab_banner
from utils.cve_checker import check_cve
from datetime import datetime

REPORTS_PATH = "reports/"

def save_report(report_data):
    """Menyimpan laporan hasil analisis ke file."""
    if not os.path.exists(REPORTS_PATH):
        os.makedirs(REPORTS_PATH)
    
    report_file = os.path.join(REPORTS_PATH, f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt")
    with open(report_file, "w") as file:
        file.write(report_data)
    print(f"[INFO] Report saved to {report_file}")

def main():
    print("Vulnerability Analysis Tool")
    print("=" * 40)
    
    target = input("Enter the target IP address or hostname: ").strip()
    print("\n[INFO] Scanning ports...")
    open_ports = scan_ports(target)

    if not open_ports:
        print("[INFO] No open ports detected.")
        return

    report = f"Vulnerability Analysis Report for {target}\n"
    report += "=" * 50 + "\n"
    for port in open_ports:
        banner = grab_banner(target, port)
        print(f"[INFO] Analyzing port {port}...")
        vulnerabilities = check_cve(banner)

        report += f"\nPort: {port}\n"
        report += f"Service Info: {banner}\n"
        report += "Vulnerabilities:\n"
        if vulnerabilities:
            for vuln in vulnerabilities:
                report += f"- {vuln}\n"
        else:
            report += "No known vulnerabilities found.\n"
    
    save_report(report)

if __name__ == "__main__":
    main()
